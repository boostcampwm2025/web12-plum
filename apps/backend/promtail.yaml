# Promtail Configuration for Plum Backend
# Winston 로그 파일을 Loki로 전송하는 설정

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  # Loki 서버 주소 (환경변수로 설정)
  - url: ${LOKI_URL}/loki/api/v1/push

scrape_configs:
  # 일반 로그 파일 (app-*.log)
  - job_name: plum-backend
    static_configs:
      - targets:
          - localhost
        labels:
          job: plum-backend
          env: ${NODE_ENV}
          __path__: /app/logs/nestjs/app-*.log

    # JSON 파싱과 타임스탬프만 처리 (동적 labels 제거)
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            message: message
      - timestamp:
          source: timestamp
          format: '2026-01-02 15:04:05' 
      - output:
          source: message

  # 에러 로그 파일 (error-*.log)
  - job_name: plum-backend-error
    static_configs:
      - targets:
          - localhost
        labels:
          job: plum-backend-error
          env: ${NODE_ENV}
          __path__: /app/logs/nestjs/error-*.log

    # JSON 파싱과 타임스탬프만 처리 (동적 labels 제거)
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            message: message
      - timestamp:
          source: timestamp
          format: '2026-01-02 15:04:05'
      - output:
          source: message
