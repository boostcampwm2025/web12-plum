# Promtail Configuration for Plum Backend
# Winston 로그 파일을 Loki로 전송하는 설정

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  # Loki 서버 주소 (환경변수로 설정)
  - url: ${LOKI_URL:-http://localhost:3100}/loki/api/v1/push

scrape_configs:
  # 일반 로그 파일 (app-*.log)
  - job_name: plum-backend
    static_configs:
      - targets:
          - localhost
        labels:
          job: plum-backend
          env: ${NODE_ENV:-development}
          __path__: /app/logs/nestjs/app-*.log

    pipeline_stages:
      # JSON 파싱
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            context: context
            trace: trace
            span: span

      # 타임스탬프 파싱
      - timestamp:
          source: timestamp
          format: '2006-01-02 15:04:05'

      # 레이블 추가
      - labels:
          level:
          context:

      # 출력 포맷
      - output:
          source: message

  # 에러 로그 파일 (error-*.log)
  - job_name: plum-backend-error
    static_configs:
      - targets:
          - localhost
        labels:
          job: plum-backend
          env: ${NODE_ENV:-development}
          level: error
          __path__: /app/logs/nestjs/error-*.log

    pipeline_stages:
      # JSON 파싱
      - json:
          expressions:
            timestamp: timestamp
            message: message
            context: context
            stack: stack
            trace: trace
            span: span

      # 타임스탬프 파싱
      - timestamp:
          source: timestamp
          format: '2006-01-02 15:04:05'

      # 레이블 추가
      - labels:
          context:

      # 출력 포맷
      - output:
          source: message
